@page "/CreatePage"

@using MEDVBiServ.Interfaces
@using MEDVBiServ.Services
@using MEDVBiServ.Contracts.Dtos
@using MEDVBiServ.Contracts.Enums

@layout OverviewLayout

@inject IJSRuntime JS
@inject IBibleApiClient bibleService
@inject ISnackbar Snackbar
@inject SlideService SlideService
@inject NavigationManager Nav

<div class="title-styling">
    <h1>Folienübersicht</h1>
</div>

<MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.False">
    <MudGrid>

        <!-- 1. Panel -->
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 420px;">
                <MudText Typo="Typo.h5">Sprache & Eingabe</MudText>

                <MudText Class="mt-6">Sprache auswählen</MudText>
                <MudSelect T="LanguageCode"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Value="SelectedLanguage"
                           ValueChanged="OnLanguageChanged">
                    <MudSelectItem Value="LanguageCode.De">Deutsch</MudSelectItem>
                    <MudSelectItem Value="LanguageCode.Fr">Français</MudSelectItem>
                </MudSelect>

                <MudText Class="mt-6">Buch</MudText>
                <MudSelect T="BookInfos"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Value="SelectedBook"
                           ValueChanged="OnBookChanged"
                           ToStringFunc="@(b => b?.Name ?? string.Empty)">
                    @foreach (var b in Books)
                    {
                        <MudSelectItem Value="b" @key="b.Id">@b.Name</MudSelectItem>
                    }
                </MudSelect>

                <!-----------------------  Kapitel / Vers Auswahl  ----------------------------------------------------------------->
                <div class="mt-4" style="display: flex; gap: 16px;">

                    <MudSelect T="int?"
                               Label="Kapitel"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Style="flex: 1;"
                               Value="SelectedChapter"
                               ValueChanged="OnChapterChanged"
                               Disabled="@(SelectedBook is null)">
                        @foreach (var c in Chapters)
                        {
                            <MudSelectItem Value="@((int?)c)" @key="c">@c</MudSelectItem>
                        }
                    </MudSelect>

                    <!-----------------------  AnfangsVers  ----------------------------------------------------------------->
                    <MudSelect T="int?"
                               Label="Vers"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Style="flex: 1;"
                               Value="SelectedVerseFrom"
                               ValueChanged="@(v => OnVerseFromChanged(v))"
                               Disabled="@(SelectedBook is null || !SelectedChapter.HasValue)">
                        @foreach (var v in VerseNumbers)
                        {
                            <MudSelectItem Value="@((int?)v)" @key="v">@v</MudSelectItem>
                        }
                    </MudSelect>

                    <!-----------------------  EndVers (optional)  ----------------------------------------------------------------->
                    <MudSelect T="int?"
                               Label="Vers"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Style="flex: 1;"
                               Value="SelectedVerseTo"
                               ValueChanged="@(v => SelectedVerseTo = v)"
                               Disabled="@(SelectedBook is null || !SelectedChapter.HasValue)">
                        @foreach (var v in VerseNumbers)
                        {
                            <MudSelectItem Value="@((int?)v)" @key="v">@v</MudSelectItem>
                        }
                    </MudSelect>

                </div>

                <MudButton Class="mt-6"
                           Variant="Variant.Filled"
                           Color="Color.Info"
                           FullWidth
                           Disabled="@(!CanAddVerse)"
                           OnClick="AddSelectedVerseOrRangeAsync">
                    Vers hinzufügen
                </MudButton>

                <MudText Typo="Typo.caption" Class="mt-2">
                    Bücher geladen: @Books.Count
                </MudText>
            </MudPaper>
        </MudItem>

        <!-- 2. Panel -->
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 420px;">
                <MudText Typo="Typo.h5">Auswahl & Reihenfolge</MudText>

                <div class="scrollable-list mt-3">
                    @if (SelectedItems.Count == 0)
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Noch keine Verse/Anmerkungen hinzugefügt.
                        </MudText>
                    }
                    else
                    {
                        @foreach (var item in SelectedItems)
                        {
                            <MudPaper Class="pa-3 mb-2 fixed-item">
                                <div class="item-content">

                                    <div class="item-text">
                                        <MudText Typo="Typo.subtitle1">
                                            <strong>@item.Display</strong>
                                        </MudText>

                                        @if (!string.IsNullOrWhiteSpace(item.Text))
                                        {
                                            <MudText Typo="Typo.body2" Class="body-text">
                                                @item.Text
                                            </MudText>
                                        }
                                    </div>

                                    <div class="item-actions">
                                        <MudIconButton Size="Size.Small"
                                                       Icon="@Icons.Material.Filled.ArrowUpward"
                                                       Disabled="@(item == SelectedItems.First())"
                                                       OnClick="@(() => MoveUp(item))"
                                                       Color="Color.Primary" />

                                        <MudIconButton Size="Size.Small"
                                                       Icon="@Icons.Material.Filled.ArrowDownward"
                                                       Disabled="@(item == SelectedItems.Last())"
                                                       OnClick="@(() => MoveDown(item))"
                                                       Color="Color.Primary" />

                                        <MudIconButton Size="Size.Small"
                                                       Icon="@Icons.Material.Filled.Delete"
                                                       OnClick="@(() => RemoveItem(item))"
                                                       Color="Color.Error" />
                                    </div>


                                </div>
                            </MudPaper>

                        }
                    }
                </div>
            </MudPaper>
        </MudItem>

        <!-- 3. Panel -->
        <MudItem xs="12" sm="12" md="4">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 420px;">
                <MudText Typo="Typo.h5">Anmerkung hinzufügen</MudText>

                <MudTextField T="string"
                              Label="Deine Anmerkung..."
                              Variant="Variant.Outlined"
                              @bind-Value="NewAnnotation"
                              Lines="4"
                              FullWidth="true"
                              TextAlign="TextAlign.Start"
                              Class="mb-3" />

                <div class="d-flex justify-center">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               OnClick="SaveAnnotation">
                        ➕ Anmerkung speichern
                    </MudButton>
                </div>
            </MudPaper>
        </MudItem>

        <!-- 4. Panel -->
        <MudItem xs="12" sm="6" md="12">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 400px;">
                <MudText Typo="Typo.h5">Vorschau (Reihenfolge)</MudText>
                <div class="scrollable-list mt-3">
                    <ol class="pl-4">
                        @foreach (var item in SelectedItems)
                        {
                            <li class="mb-3">
                                @if (item.Type == "verse")
                                {
                                    <div>
                                        <strong>@item.Display</strong><br />
                                        <em>@item.Text</em>
                                    </div>
                                }
                                else if (item.Type == "annotation")
                                {
                                    <div>
                                        <strong>@item.Display</strong>
                                    </div>
                                }
                            </li>
                        }
                    </ol>
                </div>
                

                <div class="d-flex justify-center mt-4">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.PlayArrow"
                               OnClick="OpenPresentation">
                        🚀 Folien generieren
                    </MudButton>
                </div>
            </MudPaper>
        </MudItem>

    </MudGrid>
</MudContainer>

@code
{
    private LanguageCode SelectedLanguage = LanguageCode.De;

    public class SlideItem
    {
        public string Type { get; set; } = "verse";          // "verse" oder "annotation"
        public string Display { get; set; } = string.Empty;  // "1. Mose 1:1-3" / "Joh 3:16"
        public string Text { get; set; } = string.Empty;     // Vers-Text (bei Range zusammengefügt)
    }

    private List<SlideItem> SelectedItems = new();

    private List<BookInfos> Books = new();
    private BookInfos? SelectedBook;

    private List<int> Chapters = new();
    private int? SelectedChapter;

    private List<int> VerseNumbers = new();
    private int? SelectedVerseFrom;
    private int? SelectedVerseTo;

    private bool CanAddVerse =>
        SelectedBook is not null &&
        SelectedChapter.HasValue &&
        SelectedVerseFrom.HasValue;

    // Duplikate verhindern (Key: lang|book|chapter|from-to)
    private readonly HashSet<string> _verseKeys = new();
    private readonly Dictionary<SlideItem, string> _keyByItem = new();

    private static string MakeKey(LanguageCode lang, int book, int chapter, int fromVerse, int? toVerse)
    {
        var to = toVerse ?? fromVerse;
        if (to < fromVerse) (fromVerse, to) = (to, fromVerse);
        return $"{lang}|{book}|{chapter}|{fromVerse}-{to}";
    }

    private string NewAnnotation = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await ReloadBooksAsync();
    }

    private async Task OnLanguageChanged(LanguageCode value)
    {
        SelectedLanguage = value;
        await ReloadBooksAsync();
    }

    private async Task OnBookChanged(BookInfos? value)
    {
        SelectedBook = value;
        await ReloadChaptersAsync();
    }

    private async Task OnChapterChanged(int? value)
    {
        SelectedChapter = value;
        await ReloadVerseNumbersAsync();
    }

    private void OnVerseFromChanged(int? value)
    {
        SelectedVerseFrom = value;

        // Optional: wenn "To" leer ist, direkt auf "From" setzen (fühlt sich in der UI gut an)
        if (SelectedVerseFrom.HasValue && !SelectedVerseTo.HasValue)
            SelectedVerseTo = SelectedVerseFrom;
    }

    private async Task ReloadBooksAsync()
    {
        try
        {
            Books = await bibleService.GetBooksAsync(SelectedLanguage);

            SelectedBook = null;
            SelectedChapter = null;
            SelectedVerseFrom = null;
            SelectedVerseTo = null;

            Chapters.Clear();
            VerseNumbers.Clear();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden der Bücher: {ex.Message}", Severity.Error);
        }
    }

    private async Task ReloadChaptersAsync()
    {
        Chapters.Clear();
        VerseNumbers.Clear();

        SelectedChapter = null;
        SelectedVerseFrom = null;
        SelectedVerseTo = null;

        if (SelectedBook is null) return;

        try
        {
            Chapters = await bibleService.GetChaptersAsync(SelectedLanguage, SelectedBook.Id);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden der Kapitel: {ex.Message}", Severity.Error);
        }
    }

    private async Task ReloadVerseNumbersAsync()
    {
        VerseNumbers.Clear();

        SelectedVerseFrom = null;
        SelectedVerseTo = null;

        if (SelectedBook is null || !SelectedChapter.HasValue) return;

        try
        {
            var verses = await bibleService.GetVersesFromChapterAsync(SelectedLanguage, SelectedBook.Id, SelectedChapter.Value);
            VerseNumbers = verses.Select(v => v.Verse).Distinct().OrderBy(v => v).ToList();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden der Verse: {ex.Message}", Severity.Error);
        }
    }

    private async Task AddSelectedVerseOrRangeAsync()
    {
        if (!CanAddVerse) return;

        var bookId = SelectedBook!.Id;
        var bookName = SelectedBook!.Name;
        var chapter = SelectedChapter!.Value;

        var from = SelectedVerseFrom!.Value;
        var to = SelectedVerseTo ?? from;
        if (to < from) (from, to) = (to, from);

        // Falls "To" gesetzt ist, aber außerhalb: einfach auf From reduzieren
        if (!VerseNumbers.Contains(from))
        {
            Snackbar.Add("Der ausgewählte Anfangsvers ist ungültig.", Severity.Warning);
            return;
        }

        if (!VerseNumbers.Contains(to))
        {
            // Wenn To ungültig -> automatisch Single Verse
            to = from;
        }

        var key = MakeKey(SelectedLanguage, bookId, chapter, from, to);
        if (_verseKeys.Contains(key))
        {
            Snackbar.Add("Dieser Vers/Bereich ist bereits in der Auswahl.", Severity.Warning);
            return;
        }

        try
        {
            // Single
            if (from == to)
            {
                var dto = await bibleService.GetSingleVerseAsync(SelectedLanguage, bookId, chapter, from);
                if (dto is null)
                {
                    Snackbar.Add($"Vers nicht gefunden: {bookName} {chapter}:{from}", Severity.Error);
                    return;
                }

                var item = new SlideItem
                {
                    Type = "verse",
                    Display = $"{dto.BookName} {dto.Chapter}:{dto.Verse}",
                    Text = dto.Text
                };

                SelectedItems.Add(item);
                _verseKeys.Add(key);
                _keyByItem[item] = key;

                StateHasChanged();
                return;
            }

            // Range
            var list = await bibleService.GetVerseRangeAsync(SelectedLanguage, bookId, chapter, from, to);
            if (list is null || list.Count == 0)
            {
                Snackbar.Add($"Versbereich nicht gefunden: {bookName} {chapter}:{from}-{to}", Severity.Error);
                return;
            }

            // Texte zu einem Slide zusammenfassen (Display bleibt wie gehabt)
            var header = $"{list[0].BookName} {chapter}:{from}-{to}";
            var text = string.Join(" ", list.OrderBy(v => v.Verse).Select(v => v.Text));

            var rangeItem = new SlideItem
            {
                Type = "verse",
                Display = header,
                Text = text
            };

            SelectedItems.Add(rangeItem);
            _verseKeys.Add(key);
            _keyByItem[rangeItem] = key;

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Hinzufügen: {ex.Message}", Severity.Error);
        }
    }

    private void SaveAnnotation()
    {
        if (string.IsNullOrWhiteSpace(NewAnnotation)) return;

        var item = new SlideItem
        {
            Type = "annotation",
            Display = NewAnnotation.Trim(),
            Text = string.Empty
        };

        SelectedItems.Add(item);
        NewAnnotation = string.Empty;

        StateHasChanged();
    }

    private void MoveUp(SlideItem item)
    {
        var index = SelectedItems.IndexOf(item);
        if (index <= 0) return;

        SelectedItems.RemoveAt(index);
        SelectedItems.Insert(index - 1, item);
        StateHasChanged();
    }

    private void MoveDown(SlideItem item)
    {
        var index = SelectedItems.IndexOf(item);
        if (index < 0 || index >= SelectedItems.Count - 1) return;

        SelectedItems.RemoveAt(index);
        SelectedItems.Insert(index + 1, item);
        StateHasChanged();
    }

    private void RemoveItem(SlideItem item)
    {
        SelectedItems.Remove(item);

        // Falls es ein Vers/Range ist: Duplikat-Key freigeben
        if (_keyByItem.TryGetValue(item, out var key))
        {
            _keyByItem.Remove(item);
            _verseKeys.Remove(key);
        }

        StateHasChanged();
    }

    private async Task OpenPresentation()
    {
        await JS.InvokeVoidAsync("localStorage.setItem", "slides", System.Text.Json.JsonSerializer.Serialize(SelectedItems));
        await JS.InvokeVoidAsync("window.open", "/present", "_blank");
    }
}

<style>
    .title-styling {
        margin: 2em;
    }

    .scrollable-list {
        max-height: 340px;
        overflow-y: auto;
        padding-right: 6px;
    }

        .scrollable-list::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable-list::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

    .fixed-item {
        height: 100px;
        display: flex;
        align-items: center;
        overflow: hidden; /* Sicherheitsnetz */
    }

    .item-content {
        width: 100%;
        display: flex;
        align-items: center; /* vertikal mittig */
        justify-content: space-between;
        gap: 12px;
    }

    .item-text {
        flex: 1; /* nimmt den Platz */
        min-width: 0; /* wichtig für overflow */
        overflow: hidden;
    }

    .item-actions {
        width: 44px;
        height: 100%; /* nimmt exakt die Item-Höhe */
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* oben / mitte / unten */
        align-items: center;
        padding: 6px 0; /* Luft oben/unten */
        gap: 0; /* gap nicht nötig bei space-between */
    }


        /* Mehrzeiliger Text mit Cut (empfohlen) */
        .item-text .body-text {
            display: -webkit-box;
            -webkit-line-clamp: 2; /* max. 2 Zeilen */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

    

</style>
