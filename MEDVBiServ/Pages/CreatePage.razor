@page "/CreatePage"

@using MEDVBiServ.Interfaces
@using MEDVBiServ.Services
@using MEDVBiServ.Contracts.Dtos
@using MEDVBiServ.Contracts.Enums

@layout OverviewLayout

@inject IJSRuntime JS
@inject IBibleApiClient bibleService
@inject ISnackbar Snackbar
@inject SlideService SlideService
@inject NavigationManager Nav

<div class="title-styling">
    <h1>Folienübersicht</h1>
</div>

<MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.False">
    <MudGrid>

        <!-- 1. Panel -->
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 420px;">
                <MudText Typo="Typo.h5">Sprache & Eingabe</MudText>

                <MudText Class="mt-6">Sprache auswählen</MudText>
                <MudSelect T="LanguageCode"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Value="SelectedLanguage"
                           ValueChanged="OnLanguageChanged">
                    <MudSelectItem Value="LanguageCode.De">Deutsch</MudSelectItem>
                    <MudSelectItem Value="LanguageCode.Fr">Français</MudSelectItem>
                </MudSelect>

                <MudText Class="mt-6">Buch</MudText>
                <MudSelect T="BookInfos"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Value="SelectedBook"
                           ValueChanged="OnBookChanged"
                           ToStringFunc="@(b => b?.Name ?? string.Empty)">
                    @foreach (var b in Books)
                    {
                        <MudSelectItem Value="b" @key="b.Id">@b.Name</MudSelectItem>
                    }
                </MudSelect>

                <div class="mt-4" style="display: flex; gap: 16px;">
                    <MudSelect T="int?"
                               Label="Kapitel"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Style="flex: 1;"
                               Value="SelectedChapter"
                               ValueChanged="OnChapterChanged"
                               Disabled="@(SelectedBook is null)">
                        @foreach (var c in Chapters)
                        {
                            <MudSelectItem Value="@((int?)c)" @key="c">@c</MudSelectItem>
                        }
                    </MudSelect>

                    <MudSelect T="int?"
                               Label="Vers"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Style="flex: 1;"
                               Value="SelectedVerse"
                               ValueChanged="@(v => SelectedVerse = v)"
                               Disabled="@(SelectedBook is null || !SelectedChapter.HasValue)">
                        @foreach (var v in VerseNumbers)
                        {
                            <MudSelectItem Value="@((int?)v)" @key="v">@v</MudSelectItem>
                        }
                    </MudSelect>
                </div>

                <MudButton Class="mt-6"
                           Variant="Variant.Filled"
                           Color="Color.Info"
                           FullWidth
                           Disabled="@(!CanAddSingleVerse)"
                           OnClick="AddSingleVerseAsync">
                    Vers hinzufügen
                </MudButton>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.subtitle2">Multi-Vers (z.B. 16-18 oder 16,18,21)</MudText>
                <MudTextField T="string"
                              Variant="Variant.Outlined"
                              Dense="true"
                              Placeholder="z.B. 16-18"
                              @bind-Value="MultiVerseInput"
                              Disabled="@(SelectedBook is null || !SelectedChapter.HasValue)" />

                <MudButton Class="mt-3"
                           Variant="Variant.Outlined"
                           Color="Color.Primary"
                           FullWidth
                           Disabled="@(!CanAddMultiVerses)"
                           OnClick="AddMultiVersesAsync">
                    Multi-Vers hinzufügen
                </MudButton>

                <MudText Typo="Typo.caption" Class="mt-2">
                    Bücher geladen: @Books.Count
                </MudText>
            </MudPaper>
        </MudItem>

        <!-- 2. Panel -->
        <MudItem xs="12" sm="6" md="4">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 420px;">
                <MudText Typo="Typo.h5">Auswahl & Reihenfolge</MudText>

                <div class="scrollable-list mt-3">
                    @if (SelectedItems.Count == 0)
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Noch keine Verse/Anmerkungen hinzugefügt.
                        </MudText>
                    }
                    else
                    {
                        @foreach (var item in SelectedItems)
                        {
                            <MudPaper Class="pa-3 mb-2" Style="border-radius: 12px; background-color: #f8f8f8;">
                                <div class="d-flex justify-between align-center">
                                    <div style="max-width: 75%;">
                                        <MudText Typo="Typo.subtitle1"><strong>@item.Display</strong></MudText>
                                        @if (!string.IsNullOrWhiteSpace(item.Text))
                                        {
                                            <MudText Typo="Typo.body2">@item.Text</MudText>
                                        }
                                    </div>

                                    <div>
                                        <MudIconButton Icon="@Icons.Material.Filled.ArrowUpward"
                                                       Disabled="@(item == SelectedItems.First())"
                                                       OnClick="@(() => MoveUp(item))"
                                                       Color="Color.Primary" />
                                        <MudIconButton Icon="@Icons.Material.Filled.ArrowDownward"
                                                       Disabled="@(item == SelectedItems.Last())"
                                                       OnClick="@(() => MoveDown(item))"
                                                       Color="Color.Primary" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                       OnClick="@(() => RemoveItem(item))"
                                                       Color="Color.Error" />
                                    </div>
                                </div>
                            </MudPaper>
                        }
                    }
                </div>
            </MudPaper>
        </MudItem>

        <!-- 3. Panel -->
        <MudItem xs="12" sm="12" md="4">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 420px;">
                <MudText Typo="Typo.h5">Anmerkung hinzufügen</MudText>

                <MudTextField T="string"
                              Label="Deine Anmerkung..."
                              Variant="Variant.Outlined"
                              @bind-Value="NewAnnotation"
                              Lines="4"
                              FullWidth="true"
                              TextAlign="TextAlign.Start"
                              Class="mb-3" />

                <div class="d-flex justify-center">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               OnClick="SaveAnnotation">
                        ➕ Anmerkung speichern
                    </MudButton>
                </div>
            </MudPaper>
        </MudItem>

        <!-- 4. Panel -->
        <MudItem xs="12" sm="6" md="12">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 420px;">
                <MudText Typo="Typo.h5">Vorschau (Reihenfolge)</MudText>

                <ol class="pl-4 mt-3">
                    @foreach (var item in SelectedItems)
                    {
                        <li class="mb-3">
                            @if (item.Type == "verse")
                            {
                                <div>
                                    <strong>@item.Display</strong><br />
                                    <em>@item.Text</em>
                                </div>
                            }
                            else if (item.Type == "annotation")
                            {
                                <div>
                                    <strong>@item.Display</strong>
                                </div>
                            }
                        </li>
                    }
                </ol>

                <div class="d-flex justify-center mt-4">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.PlayArrow"
                               Disabled="@(SelectedItems.Count == 0)"
                               OnClick="OpenPresentation">
                        🚀 Folien generieren
                    </MudButton>
                </div>
            </MudPaper>
        </MudItem>

    </MudGrid>
</MudContainer>

@code
{
    private LanguageCode SelectedLanguage = LanguageCode.De;

    public class SlideItem
    {
        public string Type { get; set; } = "verse";       // "verse" oder "annotation"
        public string Display { get; set; } = string.Empty; // "Johannes 3:16"
        public string Text { get; set; } = string.Empty;    // Vers-Text
    }

    private List<SlideItem> SelectedItems = new();

    private List<BookInfos> Books = new();
    private BookInfos? SelectedBook;

    private List<int> Chapters = new();
    private int? SelectedChapter;

    private List<int> VerseNumbers = new();
    private int? SelectedVerse;

    private string MultiVerseInput = string.Empty;

    private bool CanAddSingleVerse => SelectedBook is not null && SelectedChapter.HasValue && SelectedVerse.HasValue;
    private bool CanAddMultiVerses => SelectedBook is not null && SelectedChapter.HasValue && !string.IsNullOrWhiteSpace(MultiVerseInput);

    // Duplikate verhindern (Key: lang|book|chapter|verse)
    private readonly HashSet<string> _verseKeys = new();
    private readonly Dictionary<SlideItem, string> _keyByItem = new();

    private string NewAnnotation = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await ReloadBooksAsync();
    }

    private async Task OnLanguageChanged(LanguageCode value)
    {
        SelectedLanguage = value;
        await ReloadBooksAsync();
    }

    private async Task OnBookChanged(BookInfos? value)
    {
        SelectedBook = value;
        await ReloadChaptersAsync();
    }

    private async Task OnChapterChanged(int? value)
    {
        SelectedChapter = value;
        await ReloadVerseNumbersAsync();
    }

    private async Task ReloadBooksAsync()
    {
        try
        {
            Books = await bibleService.GetBooksAsync(SelectedLanguage);

            SelectedBook = null;
            SelectedChapter = null;
            SelectedVerse = null;

            Chapters.Clear();
            VerseNumbers.Clear();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden der Bücher: {ex.Message}", Severity.Error);
        }
    }

    private async Task ReloadChaptersAsync()
    {
        Chapters.Clear();
        VerseNumbers.Clear();
        SelectedChapter = null;
        SelectedVerse = null;

        if (SelectedBook is null) return;

        try
        {
            Chapters = await bibleService.GetChaptersAsync(SelectedLanguage, SelectedBook.Id);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden der Kapitel: {ex.Message}", Severity.Error);
        }
    }

    private async Task ReloadVerseNumbersAsync()
    {
        VerseNumbers.Clear();
        SelectedVerse = null;

        if (SelectedBook is null || !SelectedChapter.HasValue) return;

        try
        {
            var verses = await bibleService.GetVersesFromChapterAsync(SelectedLanguage, SelectedBook.Id, SelectedChapter.Value);
            VerseNumbers = verses.Select(v => v.Verse).Distinct().OrderBy(v => v).ToList();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Fehler beim Laden der Verse: {ex.Message}", Severity.Error);
        }
    }

    private static string MakeKey(LanguageCode lang, int book, int chapter, int verse)
        => $"{lang}|{book}|{chapter}|{verse}";

    private async Task AddSingleVerseAsync()
    {
        if (!CanAddSingleVerse) return;

        await AddVerseCoreAsync(SelectedLanguage, SelectedBook!.Id, SelectedChapter!.Value, SelectedVerse!.Value, SelectedBook!.Name);
    }

    private async Task AddMultiVersesAsync()
    {
        if (SelectedBook is null || !SelectedChapter.HasValue) return;

        var verseList = ParseVerseList(MultiVerseInput);
        if (verseList.Count == 0)
        {
            Snackbar.Add("Bitte gültige Verse eingeben (z.B. 16-18 oder 16,18,21).", Severity.Warning);
            return;
        }

        foreach (var v in verseList)
            await AddVerseCoreAsync(SelectedLanguage, SelectedBook.Id, SelectedChapter.Value, v, SelectedBook.Name);

        MultiVerseInput = string.Empty;
    }

    private async Task<bool> AddVerseCoreAsync(LanguageCode lang, int bookId, int chapter, int verse, string bookName)
    {
        var key = MakeKey(lang, bookId, chapter, verse);
        if (_verseKeys.Contains(key))
        {
            Snackbar.Add("Dieser Vers ist bereits in der Auswahl.", Severity.Warning);
            return false;
        }

        var dto = await bibleService.GetSingleVerseAsync(lang, bookId, chapter, verse);
        if (dto is null)
        {
            Snackbar.Add($"Vers nicht gefunden: {bookName} {chapter}:{verse}", Severity.Error);
            return false;
        }

        var item = new SlideItem
        {
            Type = "verse",
            Display = $"{dto.BookName} {dto.Chapter}:{dto.Verse}",
            Text = dto.Text
        };

        SelectedItems.Add(item);
        _verseKeys.Add(key);
        _keyByItem[item] = key;

        return true;
    }

    private static List<int> ParseVerseList(string input)
    {
        input = (input ?? "").Trim();
        if (string.IsNullOrWhiteSpace(input)) return new();

        var result = new List<int>();
        var parts = input.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

        foreach (var part in parts)
        {
            if (part.Contains('-', StringComparison.Ordinal))
            {
                var range = part.Split('-', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
                if (range.Length != 2) continue;

                if (int.TryParse(range[0], out var start) && int.TryParse(range[1], out var end))
                {
                    if (start <= 0 || end <= 0) continue;
                    if (end < start) (start, end) = (end, start);

                    for (var i = start; i <= end; i++)
                        result.Add(i);
                }
            }
            else if (int.TryParse(part, out var single) && single > 0)
            {
                result.Add(single);
            }
        }

        var seen = new HashSet<int>();
        return result.Where(v => seen.Add(v)).ToList();
    }

    private void SaveAnnotation()
    {
        if (string.IsNullOrWhiteSpace(NewAnnotation)) return;

        SelectedItems.Add(new SlideItem
        {
            Type = "annotation",
            Display = NewAnnotation.Trim(),
            Text = string.Empty
        });

        NewAnnotation = string.Empty;
        StateHasChanged();
    }

    private void MoveUp(SlideItem item)
    {
        var index = SelectedItems.IndexOf(item);
        if (index <= 0) return;

        SelectedItems.RemoveAt(index);
        SelectedItems.Insert(index - 1, item);
        StateHasChanged();
    }

    private void MoveDown(SlideItem item)
    {
        var index = SelectedItems.IndexOf(item);
        if (index < 0 || index >= SelectedItems.Count - 1) return;

        SelectedItems.RemoveAt(index);
        SelectedItems.Insert(index + 1, item);
        StateHasChanged();
    }

    private void RemoveItem(SlideItem item)
    {
        SelectedItems.Remove(item);

        // Falls es ein Vers ist: Duplikat-Key freigeben
        if (_keyByItem.TryGetValue(item, out var key))
        {
            _keyByItem.Remove(item);
            _verseKeys.Remove(key);
        }

        StateHasChanged();
    }

    private async Task OpenPresentation()
    {
        // localStorage (robust, auch in neuem Tab)
        await JS.InvokeVoidAsync("localStorage.setItem", "slides", System.Text.Json.JsonSerializer.Serialize(SelectedItems));
        await JS.InvokeVoidAsync("window.open", "/present", "_blank");
    }
}

<style>
    .title-styling {
        margin: 2em;
    }

    .scrollable-list {
        max-height: 340px;
        overflow-y: auto;
        padding-right: 6px;
    }

        .scrollable-list::-webkit-scrollbar {
            width: 6px;
        }

        .scrollable-list::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
</style>
