@page "/"

@using System.Text.Json
@using System.Globalization;

@inject IJSRuntime JS
@layout MainLayout

@inject NavigationManager NavigationManager

<MudContainer MaxWidth="MaxWidth.False" Class="mt-10 px-8">

    <!-- HERO -->
    <MudPaper Elevation="2" Class="pa-8 hero">
        <MudGrid AlignItems="AlignItems.Center" Spacing="4">

            <MudItem xs="12" md="7">
                <MudText Typo="Typo.h3" Class="fw-700">
                    MEDVBiServ – Bibelverse schnell zu Folien
                </MudText>

                <MudText Typo="Typo.subtitle1" Class="mt-2 text-muted">
                    Verse auswählen, Reihenfolge festlegen, Anmerkungen hinzufügen und in Sekunden eine Präsentation erstellen –
                    für PC und Smartphone, sauber und zuverlässig.
                </MudText>
            </MudItem>

            <!-- Top KPI Row -->
            <MudGrid Spacing="3" Class="mt-6">

                <MudItem xs="12" sm="6" md="6">
                    <MudPaper Elevation="2" Class="pa-4 kpi-card">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Large" Color="Color.Primary" />
                            <div>
                                <MudText Typo="Typo.caption" Class="text-muted">Datum & Uhrzeit</MudText>
                                <MudText Typo="Typo.h6" Class="fw-700">@NowText</MudText>
                            </div>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6" md="6">
                    <MudPaper Elevation="2" Class="pa-4 kpi-card">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.FormatListNumbered" Size="Size.Large" Color="Color.Info" />
                            <div>
                                <MudText Typo="Typo.caption" Class="text-muted">Aktuelle Auswahl</MudText>
                                <MudText Typo="Typo.h4" Class="fw-700">@SelectedCount</MudText>
                            </div>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6" md="6">
                    <MudPaper Elevation="2" Class="pa-4 kpi-card">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Notes" Size="Size.Large" Color="Color.Secondary" />
                            <div>
                                <MudText Typo="Typo.caption" Class="text-muted">Anmerkungen</MudText>
                                <MudText Typo="Typo.h4" Class="fw-700">@AnnotationCount</MudText>
                            </div>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" sm="6" md="6">
                    <MudPaper Elevation="2" Class="pa-4 kpi-card">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Large" Color="Color.Success" />
                            <div>
                                <MudText Typo="Typo.caption" Class="text-muted">Zuletzt erstellt</MudText>
                                <MudText Typo="Typo.h6" Class="fw-700">@LastCreatedText</MudText>
                            </div>
                        </MudStack>
                    </MudPaper>
                </MudItem>

            </MudGrid>


        </MudGrid>
    </MudPaper>
</MudContainer>


@code {

    

    private readonly JsonSerializerOptions _jsonOptions = new(JsonSerializerDefaults.Web);
    private readonly CultureInfo _de = new("de-DE");
    private string NowText => _now.ToString("dddd, dd.MM.yyyy • HH:mm:ss", _de);

    private System.Timers.Timer? _timer;
    private DateTime _now = DateTime.Now;
   

    // Dashboard-Daten (aus localStorage)
    private List<SlideItem> LastItems = new();
    private DateTime? LastCreatedAt;

    private int SelectedCount => LastItems.Count;
    private int AnnotationCount => LastItems.Count(x => x.Type == "annotation");

    private string LastCreatedText =>
        LastCreatedAt is null
            ? (LastItems.Count == 0 ? "—" : "Zeitstempel fehlt")
            : LastCreatedAt.Value.ToString("dd.MM.yyyy • HH:mm");

    protected override async Task OnInitializedAsync()
    {
        StartClock();
        await ReloadFromLocalStorage();
    }

    private void StartClock()
    {
        _timer = new System.Timers.Timer(1000);
        _timer.Elapsed += (_, __) =>
        {
            _now = DateTime.Now;
            InvokeAsync(StateHasChanged);
        };
        _timer.AutoReset = true;
        _timer.Start();
    }

    private async Task ReloadFromLocalStorage()
    {
        // slides
        var slidesJson = await JS.InvokeAsync<string>("localStorage.getItem", "slides");
        if (!string.IsNullOrWhiteSpace(slidesJson))
        {
            try
            {
                LastItems = JsonSerializer.Deserialize<List<SlideItem>>(slidesJson, _jsonOptions) ?? new();
            }
            catch
            {
                LastItems = new();
            }
        }
        else
        {
            LastItems = new();
        }

        // createdAt (optional)
        var createdAt = await JS.InvokeAsync<string>("localStorage.getItem", "slidesCreatedAt");
        if (!string.IsNullOrWhiteSpace(createdAt) && DateTime.TryParse(createdAt, out var dt))
            LastCreatedAt = dt;
        else
            LastCreatedAt = null;

        StateHasChanged();
    }

    private static string Shorten(string text, int max)
        => string.IsNullOrWhiteSpace(text) ? "" : (text.Length <= max ? text : text.Substring(0, max) + "…");

    public class SlideItem
    {
        public string Type { get; set; } = "verse";
        public string Display { get; set; } = string.Empty;
        public string Text { get; set; } = string.Empty;
    }

    public void Dispose()
    {
        _timer?.Stop();
        _timer?.Dispose();
    }
}

<style>
    .fw-700 {
        font-weight: 700;
    }

    .text-muted {
        opacity: .75;
    }

    .rounded-16 {
        border-radius: 16px;
    }

    .kpi-card {
        border-radius: 16px;
    }
</style>

}
